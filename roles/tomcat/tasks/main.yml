---
# ============================================================
# TOMCAT 11 PORTABLE INSTALLATION (NO ROOT)
# Uses Java 25 (via setenv.sh)
# ============================================================

# ------------------------------------------------------------
# Create Tomcat directory
# ------------------------------------------------------------
- name: Create Tomcat directory under home
  file:
    path: "/home/{{ ansible_user }}/tomcat"
    state: directory

# ------------------------------------------------------------
# Download Tomcat 11.0.1
# ------------------------------------------------------------
- name: Download Tomcat 11.0.1 archive
  get_url:
    url: "https://archive.apache.org/dist/tomcat/tomcat-11/v11.0.1/bin/apache-tomcat-11.0.1.tar.gz"
    dest: "/home/{{ ansible_user }}/tomcat/tomcat.tar.gz"

# ------------------------------------------------------------
# Extract Tomcat (Portable)
# ------------------------------------------------------------
- name: Extract Tomcat archive
  unarchive:
    src: "/home/{{ ansible_user }}/tomcat/tomcat.tar.gz"
    dest: "/home/{{ ansible_user }}/tomcat"
    remote_src: yes
    extra_opts: ["--strip-components=1"]

# ------------------------------------------------------------
# Make Tomcat scripts executable
# ------------------------------------------------------------
- name: Make Tomcat startup scripts executable
  file:
    path: "{{ item }}"
    mode: '0755'
  loop:
    - "/home/{{ ansible_user }}/tomcat/bin/startup.sh"
    - "/home/{{ ansible_user }}/tomcat/bin/shutdown.sh"

# ------------------------------------------------------------
# Change Tomcat HTTP port â†’ 9090
# ------------------------------------------------------------
- name: Change Tomcat server port to 9090
  replace:
    path: "/home/{{ ansible_user }}/tomcat/conf/server.xml"
    regexp: 'port="8080"'
    replace: 'port="9090"'

# ------------------------------------------------------------
# Enable WAR deployment (Tomcat 11 requires this)
# ------------------------------------------------------------
- name: Enable autoDeploy/unpackWARs/deployOnStartup
  replace:
    path: "/home/{{ ansible_user }}/tomcat/conf/server.xml"
    regexp: '<Host name="localhost" appBase="webapps".*>'
    replace: '<Host name="localhost" appBase="webapps" unpackWARs="true" autoDeploy="true" deployOnStartup="true">'

# ------------------------------------------------------------
# Enable Manager GUI
# ------------------------------------------------------------
- name: Create tomcat-users.xml with admin user
  copy:
    dest: "/home/{{ ansible_user }}/tomcat/conf/tomcat-users.xml"
    mode: '0644'
    content: |
      <tomcat-users>
          <role rolename="manager-gui"/>
          <role rolename="manager-script"/>
          <user username="admin" password="admin123" roles="manager-gui,manager-script"/>
      </tomcat-users>

# ------------------------------------------------------------
# Disable manager IP restrictions
# ------------------------------------------------------------
- name: Remove default Valve restrictions in manager/context.xml
  replace:
    path: "/home/{{ ansible_user }}/tomcat/webapps/manager/META-INF/context.xml"
    regexp: '(<Valve.*)?'
    replace: ''

# ------------------------------------------------------------
# Use Java 25 for Tomcat (CRITICAL)
# ------------------------------------------------------------
- name: Create setenv.sh to force JAVA_HOME=Java25
  copy:
    dest: "/home/{{ ansible_user }}/tomcat/bin/setenv.sh"
    mode: '0755'
    content: |
      echo "[SETENV] Using JAVA_HOME=/home/{{ ansible_user }}/java/jdk-25.0.1"
      export JAVA_HOME=/home/{{ ansible_user }}/java/jdk-25.0.1
      export PATH=$JAVA_HOME/bin:$PATH

# ------------------------------------------------------------
# Stop Tomcat (if running)
# ------------------------------------------------------------
- name: Stop Tomcat
  shell: "/home/{{ ansible_user }}/tomcat/bin/shutdown.sh"
  ignore_errors: true

# ------------------------------------------------------------
# Start Tomcat
# ------------------------------------------------------------
- name: Start Tomcat (detached, no sudo)
  shell: |
    /bin/bash -l -c "nohup /home/{{ ansible_user }}/tomcat/bin/startup.sh > /dev/null 2>&1 &"


# ------------------------------------------------------------
# Wait for Tomcat to start
# ------------------------------------------------------------
- name: Wait for Tomcat on port 9090
  wait_for:
    host: "127.0.0.1"
    port: 9090
    delay: 4
    timeout: 40
